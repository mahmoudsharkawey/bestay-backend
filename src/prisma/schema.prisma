generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum Role {
  USER
  LANDLORD
  ADMIN
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum UnitType {
  ROOM
  APARTMENT
  STUDIO
}

enum RoomType {
  SINGLE
  DOUBLE
  SHARED
}

enum GenderPreference {
  MALE_ONLY
  FEMALE_ONLY
}

enum BookingStatus {
  PENDING_PAYMENT
  PAID
  VISIT_SCHEDULED
  VISIT_RESCHEDULED
  CANCELLED_BY_USER
  CANCELLED_BY_OWNER
  COMPLETED
  REFUNDED
}

//////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String?
  phone     String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())

  provider   AuthProvider @default(LOCAL)
  providerId String?
  picture    String?

  passwordResetCode     String?
  passwordResetExpiry   DateTime?
  passwordResetVerified Boolean   @default(false)

  units       Unit[]          @relation("OwnerUnits")
  bookings    Booking[]
  preferences UserPreference?
  reviews     Review[]
  favorites   Favorite[]

  @@unique([provider, providerId])
  @@index([email])
  @@index([role])
}

//////////////////////////////////////////////////
// USER PREFERENCES (AI INPUT)
//////////////////////////////////////////////////

model UserPreference {
  id       String   @id @default(uuid())
  userId   String   @unique
  unitType UnitType

  minBudget   Float
  maxBudget   Float
  city        String
  university  String?
  maxDistance Float? // optional distance from university (km)

  rooms      Int
  furnished  Boolean
  genderType String // e.g., "male only", "female only"
  facilities String[] // e.g., ["wifi", "parking", "gym"]

  user User @relation(fields: [userId], references: [id])
}

//////////////////////////////////////////////////
// UNIT (PROPERTY LISTING)
//////////////////////////////////////////////////

model Unit {
  id          String  @id @default(uuid())
  title       String
  description String
  price       Float
  city        String
  address     String
  rooms       Int
  furnished   Boolean

  university String?
  distance   Float? // distance from university (km)

  isAvailable Boolean @default(true)

  roomType   RoomType
  genderType GenderPreference

  facilities String[] // e.g., ["wifi", "parking", "gym"]
  images     String[] // URLs of unit images

  ownerId String
  owner   User   @relation("OwnerUnits", fields: [ownerId], references: [id])

  latitude  Float?
  longitude Float?

  bookings  Booking[]
  reviews   Review[]
  favorites Favorite[]

  createdAt DateTime @default(now())

  @@index([city])
  @@index([isAvailable])
  @@index([ownerId])
  @@index([price])
  @@index([roomType])
}

//////////////////////////////////////////////////
// BOOKING
//////////////////////////////////////////////////

model Booking {
  id String @id @default(uuid())

  userId String
  unitId String

  user User @relation(fields: [userId], references: [id])
  unit Unit @relation(fields: [unitId], references: [id])

  status BookingStatus @default(PENDING_PAYMENT)

  visitDate DateTime?

  depositAmount Float
  serviceFee    Float
  totalAmount   Float

  paymentIntentId String?
  paidAt          DateTime?
  expiresAt       DateTime? // When unpaid booking expires

  cancelledAt  DateTime?
  refundAmount Float?
  refundedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  payment   Payment?

  @@index([userId])
  @@index([unitId])
  @@index([status])
  @@index([expiresAt])
  @@index([paidAt])
}

//////////////////////////////////////////////////
// PAYMENT
//////////////////////////////////////////////////

model Payment {
  id              String        @id @default(uuid())
  bookingId       String        @unique
  paymentIntentId String        @unique
  amount          Float
  status          PaymentStatus
  method          String // card, wallet, etc

  booking   Booking  @relation(fields: [bookingId], references: [id])
  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// REVIEW
//////////////////////////////////////////////////

model Review {
  id      String  @id @default(uuid())
  rating  Int // 1â€“5
  comment String?

  userId String
  unitId String

  user User @relation(fields: [userId], references: [id])
  unit Unit @relation(fields: [unitId], references: [id])

  createdAt DateTime @default(now())
}

model Favorite {
  id     String @id @default(uuid())
  userId String
  unitId String

  user User @relation(fields: [userId], references: [id])
  unit Unit @relation(fields: [unitId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, unitId])
}
